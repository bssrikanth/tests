# Tweaked for dellj
include tests-shared.cfg
# Required Global Configurations
only (image_backend=filesystem)
only no_9p_export
only no_virtio_rng
only smallpages
only default_bios
only bridge
only smp2
only qcow2
only no_pci_assignable
no multi_host
no ide,xenblk,lsi_scsi,ahci,sd
no qed,qcow2v3,raw_dd,vmdk, usb2
no e1000-82540em,e1000-82545em,e1000-82544gc,xennet,nic_custom
cpu_model = "EPYC-v4"
#cpu_model = "host"
auto_cpu_model = "no"
#cpu_model_flags = ",+svm,+x2apic"
no i440fx
kill_vm = yes
enable_kvm =yes
avocado_vt_repo="https://github.com/bssrikanth/avocado-vt.git"
avocado_vt_repo_branch="upstream1212"
test_timeout=30000
avocado_guest_reinstall=yes
start_vm = yes
kill_vm = yes
usb_controller = xhci
usb_type = qemu-xhci
usb_type_usb1 = qemu-xhci
restore_image_after_testing=yes
backup_image_before_test = yes
# --- Platform ---
only q35
# --- Block devices ---
# --- Net devices ---
only virtio_net
# --- Misc ---
shutdown_method = shell
guest_dmesg_level = 2
shell_client=ssh
virtio_dev_iommu_platform=on
virtio_dev_disable_legacy=on
display = nographic
bridge=virbr0
nic_mode=tap
restore_image_after_test=yes
vm_create_timeout = 720
#machine_type_extra_params = "confidential-guest-support=sev0"
#extra_params=" -object sev-snp-guest,id=sev0,cbitpos=51,reduced-phys-bits=1,discard=both"
reboot_method=
use_mem = no
vm_secure_guest_type = snp
vm_sev_cbitpos = 51
vm_sev_reduced_phys_bits = 1
mem_devs = "upm0"
backend_mem = "memory-backend-memfd"
share_upm0 = true
prealloc_upm0 = false
reserve_upm0 = false
vm_sev_upm_devs = "upm0"
vm_sev_upm_memdev_upm0 = upm0
nic_romfile = EMPTY_STRING
kill_timeout=720
login_timeout=720
vm_sev_kernel_hashes = on 
extra_params += " -bios /home/VT_BUILD/usr/local/OVMF_AmdSev/OVMF.fd "
vga = "none"
#Test
variants:
    - qemu_sanity:
       variants:
            - stress_boot_single:
                only io-github-autotest-qemu.boot
                vms = vm1

variants:
    - kernelboot:
       kernel=/home/VT_BUILD/usr/local/bzImage
       only 22.04-server.x86_64
       variants:
            - virtioblk:
                only virtio_blk
                no virtio_scsi
                kernel_params='root=/dev/vda rw console=ttyS0,115200n8 earlyprintk=ttyS0,115200 net.ifnames=0 biosdevname=0 movable_node swiotlb=65536'
            - virtioscsi:
                only virtio_scsi
                no virtio_blk
                kernel_params='root=/dev/sda rw console=ttyS0,115200n8 earlyprintk=ttyS0,115200 net.ifnames=0 biosdevname=0 movable_node swiotlb=65536'
variants:
    - max_config:
       smp = 255
       vcpu_cores = 255
       vcpu_threads = 1
       vcpu_sockets = 1
       vm_create_timeout = 720
       kill_timeout= 720
       login_timeout= 720
       size_mem_upm0 = 179200M

    - min_config:
       smp = 1
       vcpu_cores = 1
       vcpu_threads = 1
       vcpu_sockets = 1
       vm_create_timeout = 120
       kill_timeout= 120
       login_timeout= 120
       size_mem_upm0 = 23808M

variants:
    - default:
    - with_host_phys:
       cpu_model_flags = ",host-phys-bits=true"
