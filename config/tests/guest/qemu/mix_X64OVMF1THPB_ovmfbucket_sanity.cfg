include tests-shared.cfg
only (image_backend=filesystem)
only no_9p_export
only no_virtio_rng
only smallpages
only default_bios
only bridge
only smp2
only qcow2
only no_pci_assignable
no multi_host
no ide,xenblk,lsi_scsi,ahci,sd
no qed,qcow2v3,raw_dd,vmdk, usb2
no e1000-82540em,e1000-82545em,e1000-82544gc,xennet,nic_custom
auto_cpu_model = "yes"
cpu_model_flags = ",host-phys-bits=true"
#cpu_model = "EPYC-v4"
#cpu_model = "host"
no i440fx
kill_vm = yes
enable_kvm =yes
avocado_vt_repo="https://github.com/bssrikanth/avocado-vt.git"
avocado_vt_repo_branch="nested_images"
test_timeout=24400
avocado_guest_reinstall=yes
start_vm = yes
kill_vm = yes
usb_controller = xhci
usb_type = qemu-xhci
usb_type_usb1 = qemu-xhci
restore_image_after_testing=yes
backup_image_before_test = yes
only q35
only virtio_net
shutdown_method = shell
guest_dmesg_level = 2
shell_client=ssh
virtio_dev_iommu_platform=on
virtio_dev_disable_legacy=on
bridge=virbr0
nic_mode=tap
restore_image_after_test=yes
main_vm = vm1
vm_create_timeout = 720
kill_timeout=720
login_timeout=720
nic_romfile = EMPTY_STRING
display = nographic
variants:
    - qemu_sanity:
       variants:
            - boot_svm:
              #28
                only io-github-autotest-qemu.boot
                vms = vm1
                no max_config_sev
                no fullboot.virtioblk,kernelboot.virtioblk
                only svm
            - boot_sev:
             #28
                only io-github-autotest-qemu.boot
                vms = vm1
                no max_config_svm
                only sev
                no fullboot,kernelboot.virtioblk
            - boot_seves:
              #16
                only io-github-autotest-qemu.boot
                vms = vm1
                no max_config_svm
                only seves
                no fullboot,kernelboot.virtioblk
                no OVMF_Ia3264
variants:
    - kernelboot:
       kernel=build_home/VT_BUILD/guest_kernel/arch/x86_64/boot/bzImage
       only 22.04-server.x86_64
       variants:
            - virtioblk:
                only virtio_blk
                no virtio_scsi
                kernel_params='root=/dev/vda rw console=ttyS0 net.ifnames=0 biosdevname=0 movable_node swiotlb=65536'
            - virtioscsi:
                only virtio_scsi
                no virtio_blk
                kernel_params='root=/dev/sda rw console=ttyS0 net.ifnames=0 biosdevname=0 movable_node swiotlb=65536'
    - fullboot:
       only 22.04-serverfull.x86_64
       variants:
            - virtioblk:
                only virtio_blk
                no virtio_scsi
            - virtioscsi:
                only virtio_scsi
                no virtio_blk

variants:
    - max_config_svm:
       mem = 983040
       smp = 288
       vcpu_cores = 72
       vcpu_threads = 2
       vcpu_sockets = 2
    - max_config_sev:
       mem = 983040
       smp = 255
       vcpu_cores = 255
       vcpu_threads = 1
       vcpu_sockets = 1
    - min_config:
       mem = 23808
       smp = 1
       vcpu_cores = 1
       vcpu_threads = 1
       vcpu_sockets = 1
variants:
    - svm:
       machine_type_extra_params = "kernel-irqchip=split"
    - sev:
       #machine_type_extra_params = "confidential-guest-support=sev0,vmport=off"
       vm_secure_guest_type = sev
       vm_sev_cbitpos = 51
       vm_sev_reduced_phys_bits = 1
       vm_sev_policy = 3
       variants:
            - sev_kernelhash:
                #extra_params += " -object sev-guest,id=sev0,cbitpos=51,reduced-phys-bits=1,kernel-hashes=on"
                vm_sev_kernel_hashes = on
                only OVMF_AmdSev
            - sev_nokernelhash:
                #extra_params += " -object sev-guest,id=sev0,cbitpos=51,reduced-phys-bits=1"
                vm_sev_kernel_hashes = off
                no OVMF_AmdSev
    - seves:
       #machine_type_extra_params = "confidential-guest-support=sev0,vmport=off"
       vm_secure_guest_type = sev
       vm_sev_cbitpos = 51
       vm_sev_reduced_phys_bits = 1
       vm_sev_policy = 7
       variants:
            - seves_kernelhash:
                #extra_params += " -object sev-guest,id=sev0,policy=0x5,cbitpos=51,reduced-phys-bits=1,kernel-hashes=on -no-reboot"
                vm_sev_kernel_hashes = on
                only OVMF_AmdSev
            - seves_nokernelhash:
                #extra_params += " -object sev-guest,id=sev0,policy=0x5,cbitpos=51,reduced-phys-bits=1 -no-reboot"
                vm_sev_kernel_hashes = off
                no OVMF_AmdSev
variants:
    - OVMF_X64:
       variants:
            - ovmf:
                extra_params += " -drive if=pflash,format=raw,unit=0,file=build_home/VT_BUILD/usr/local/share/qemu/OVMF_X64/OVMF.fd,readonly "
            - ovmfcodevars:
                extra_params += " -drive if=pflash,format=raw,unit=0,file=build_home/VT_BUILD/usr/local/share/qemu/OVMF_X64/OVMF_CODE.fd,readonly -drive if=pflash,format=raw,file=build_home/VT_BUILD/usr/local/share/qemu/OVMF_X64/OVMF_VARS.fd "
            - ovmfcode:
                extra_params += " -drive if=pflash,format=raw,unit=0,file=build_home/VT_BUILD/usr/local/share/qemu/OVMF_X64/OVMF_CODE.fd,readonly "
    - OVMF_Ia3264:
       variants:
            - ovmf:
                extra_params += " -drive if=pflash,format=raw,unit=0,file=build_home/VT_BUILD/usr/local/share/qemu/OVMF_Ia3264/OVMF.fd,readonly "
            - ovmfcodevars:
                extra_params += " -drive if=pflash,format=raw,unit=0,file=build_home/VT_BUILD/usr/local/share/qemu/OVMF_Ia3264/OVMF_CODE.fd,readonly -drive if=pflash,format=raw,file=build_home/VT_BUILD/usr/local/share/qemu/OVMF_Ia3264/OVMF_VARS.fd "
            - ovmfcode:
                extra_params += " -drive if=pflash,format=raw,unit=0,file=build_home/VT_BUILD/usr/local/share/qemu/OVMF_Ia3264/OVMF_CODE.fd,readonly "
    - OVMF_AmdSev:
       #machine_type = "pc-q35-7.1"
       variants:
            - ovmf:
                extra_params += " -drive if=pflash,format=raw,unit=0,file=build_home/VT_BUILD/usr/local/share/qemu/OVMF_AmdSev/OVMF.fd,readonly "
